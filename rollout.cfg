#!/usr/bin/perl -w
# This is the main configuration file for Rollout
# It defines the base classes and machines
#
# Anything in fragments/ overrides whatever is in this file.
#
# Some rules for this file:
# 1. Hostnames *must* start with a lowercase letter, and classes with an uppercase letter.
# vim:tw=100 sw=2 expandtab ft=perl foldmethod=marker

class SOE => { # {{{
  dns_search => [ "tmcr.target.local", "aws.tmcr.target.local", ],
  group => {
    nagios => {
      gid => 888339141,
    },
    admin => { },
    uxg_unix => {
      gid => 1000,
    },
    uxg_lin => {
      gid => 10003,
    },
    uxg_mkconfig => {
      gid => 459549548,
    },
  },
  user => {
    root => {
      password => '$6$A.XonecG$Akg1PePE4EelHfAJ6mKx5nnmNGm8iYFks6.3LTOh6TQc0aTzeCK4lNrpAs4VC.H89hzGPPfQRvIE.xzCzwgt51',
      force_password => 1,
    },
    cdonova1 => { # {{{
      uid => 1285334321,
      gid => 1000,
      home => '/app/home/cdonova1',
      shell => '/bin/bash',
      groups => ['admin', 'sudo', 'uxg_unix', 'uxg_lin', 'uxg_mkconfig'],
      ssh_keys => [
                    "cdonova1\@lmabd01vm",
                    "cdonova1\@desktop",
                    "cdonova1\@tlpinfmgt01vcl",
                  ],
      password => '$6$UciRnr10$nr4ilt9Fcv9Af64oM.pod5sWMCVYQ/Un30NuJFt8uau/NnHhT1MZgLnLc90Jdka5bSSY65Pom7holpNr7/dqg.',
      force_password => 1,
    }, # }}}
    nagios => {
      name => "Nagios User",
      uid => 995513267,
      gid => 888339141,
      home => '/app/home/nagios',
      shell => '/bin/bash',
      groups => ['nagios'],
      #ssh_keys => ["nagios\@tldinfrnagi1v"]
    },
    tfreelan => undef,
    #tfreelan => {
    #  uid => 51109,
    #  gid => 1000,
    #  home => '/home/tfreelan',
    #  shell => '/bin/bash',
    #  groups => ['admin', 'sudo', 'uxg_unix', 'uxg_lin', 'uxg_mkconfig'],
    #  #ssh_keys => [ ],
    #  password => '$6$t.Goqttw$taQgKKpvGxYm4mDM4XnaI3aKI3WfaG2QBuVjbZ3O6B8nMiiPDjvoCOsQGa1z85svkYGIrTUfGBh/fgzYDKkuF1',
    #},
  },
  rollout => {
    logfile => "/var/log/rollout.log",
    reorder_steps => [
      "150-packages" => 148,
      "241-file_extract" => 148,
      "800-file_append" => 149,
      "802-file_modify" => 147,
      "240-dir_check" => 249,
    ],
  },
  service => {
    ssh => 1,
    ntp => 1,
    snmpd => 1,
  },
  crontab => {
    rollout_check => [
      '0 12 * * * root /usr/local/sbin/rollout -s --no_step_labels -k motd',
    ],
  },
  packages => [
    'rcs',
    'gpm',
    'vlan',
    'ntp',
    'unzip',
    'vim-nox',
    'postfix',
    'sysstat',
    'snmpd',
    'mailutils',
    'nagios-nrpe-plugin',
    'nagios-nrpe-server',
    'nagios-plugins',
    'openssh-server',
  ],
  packages_remove => [
    'resolvconf',
    'apparmor',
    'autofs5',
    'mpt-status',
    'nano',
    'nscd',
    'rightscale',
  ],
  sysctl => {
    'kernel.sysrq' => 1,
    'net.ipv4.conf.all.secure_redirects' => 1,
    'kernel.randomize_va_space' => 1,
    'net.ipv6.conf.all.disable_ipv6' => 1,
    'net.ipv4.ip_forward' => 0,
    'net.ipv4.conf.default.rp_filter' => 2,
    'net.ipv4.conf.default.accept_source_route' => 0,
    'kernel.core_uses_pid' => 1,
    'net.ipv4.tcp_syncookies' => 1,
    'kernel.msgmnb' => 65536,
    'kernel.msgmax' => 65536,
  },
  file_append => [
    {
      file => "/etc/aliases",
      add => 'root: Chris.Donovan@target.com.au',
      match => qr/^root/,
      cmd => "/usr/bin/newaliases",
    },
    {
      file => "/etc/default/nagios-nrpe-server",
      add => 'DAEMON_OPTS="--no-ssl"',
      match => qr/^DAEMON_OPTS=/,
      create => 1,
      cmd => "/etc/init.d/nagios-nrpe-server restart",
    },
    {
      file => "/etc/apt/apt.conf",
      add => 'Dpkg::Options { "--force-confdef"; "--force-confold"; }',
      match => qr/^Dpkg::Options /,
      create => 1,
    },
    {
      file => "/etc/apt/apt.conf",
      add => "APT::Architectures { \"amd64\"; };",
      match => qr/^APT::Architectures /,
      create => 1,
    },
  ],
  file_modify => [
    "/etc/grub.d/00_header" => [
      's/^set timeout=-.*/set timeout=30/',
    ],
  ],
  file_install => {
    "/etc/timezone" => {
      mode => 0644,
      owner => 'root',
      group => 'root',
      text => 'Australia/Melbourne
',
      command => "dpkg-reconfigure -f noninteractive tzdata",
    },
    "/etc/ssh/sshd_config" => {
      source => "rollout:/files/ssh/sshd_config",
      mode => 0600,
      owner => 'root',
      group => 'root',
      command => "/etc/init.d/ssh restart",
    },
    "/etc/snmp/snmpd.conf" => {
      source => "rollout:/files/snmpd.conf",
      mode => 0600,
      owner => 'root',
      group => 'root',
      command => "/etc/init.d/snmpd restart",
    },
    "/etc/security/limits.conf" => {
      source => "rollout:/files/limits.conf",
      mode => 0640,
      owner => 'root',
      group => 'root',
    },
    "/etc/nagios/nrpe.cfg" => {
      source => "rollout:/files/nrpe/nrpe.cfg",
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => '/etc/init.d/nagios-nrpe-server restart',
    },
    "/etc/nagios/nrpe.d/checks.cfg" => {
      source => "rollout:/files/nrpe/nrpe.d/checks.cfg",
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => '/etc/init.d/nagios-nrpe-server restart',
    },
  },
  dir_install => {
    '/etc/pam.d' => {
      source => 'rollout:/files/pam.d',
      dir_mode => 0755,
      mode => 0644,
      owner => 'root',
      group => 'root',
    },
  },
}; # }}}

class Primus => { # {{{
  inherits(
    SOE,
  ),
  nameservers => [ '10.227.192.34', '10.227.200.225' ],
  domain_name => "tmcr.target.local",
  #nameservers => [ '10.227.192.48', '10.227.192.49' ],
  file_extract => {
    "rollout:/files/vmware/VMwareTools-8.6.5-652272.tar.gz" => {
      dest => "/tmp",
      check => "/usr/lib/vmware-tools",
      cmd => '/tmp/vmware-tools-distrib/vmware-install.pl d',
    },
  },
  file_install => {
    "/etc/sudoers" => {
      source => "rollout:/files/sudoers",
      mode => 0440,
      owner => 'root',
      group => 'root',
    },
    "/etc/mailname" => {
      text => "$hostname.tmcr.target.local\n",
      command => "/etc/init.d/postfix restart",
    },
  },
}; # }}}

class AWS => { # {{{
  inherits(
    SOE,
  ),
  nameservers => [ '10.227.200.225', '10.227.192.34' ],
  domain_name => "aws.tmcr.target.local",
  file_modify => [
    "/root/.ssh/authorized_keys" => [
      's/^ssh-.* Target$/#$&/',
    ],
  ],
  file_install => {
    "/etc/mailname" => {
      text => "$hostname.aws.tmcr.target.local\n",
      command => "/etc/init.d/postfix restart",
    },
    "/etc/sudoers" => {
      source => "rollout:/files/aws/sudoers",
      mode => 0440,
      owner => 'root',
      group => 'root',
    },
    "/etc/apt/sources.list" => {
      text => '# Look at /etc/apt/sources.list.d/rollout.list',
      mode => 0644,
      owner => 'root',
      group => 'root',
    },
  },
  group => {
    rightscale => undef,
    rightscale_sudo => undef,
  },
  user => {
    rightscale => undef,
    athampi => {
      uid => 5000,
      name => 'Ajith.Thampi@target.com.au',
      gid => 1000,
      home => '/app/home/athampi',
      shell => '/bin/bash',
      groups => ['sudo',],
      password => '$6$.TUmis8b$II/qMY7/ANIrOWGaf0WGofGiB537brEMI2ExQ9JzCUuuEmIlrtZbsDXvvm1kjJINEvkibV6xcDmNlwu4hC6VM/',
      force_password => 1,
    },
  },
  apt => {
    repos => [
      'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise main',
      'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates main',
      'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security main',
      'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise universe',
      'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates universe',
      'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security universe',
      'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise multiverse',
      'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates multiverse',
      'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security multiverse',
      #'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise restricted',
      #'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates restricted',
      #'deb http://tlpinfmgt01vcl.aws.tmcr.target.local/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security restricted',
    ],
    always_check => 1,
    auto_upgrade => 0,
  },
}; # }}}
class AWS_Users => { # {{{
  group => {
    sneilson => { # {{{
      gid => 5001,
    }, # }}}
    operator => { # {{{
      gid => 15000,
    }, # }}}
    kbessaih => { # {{{
      gid => 5002,
    }, # }}}
    cnithyan => { # {{{
      gid => 5003,
    }, # }}}
    dvandort => { # {{{
      gid => 5004,
    }, # }}}
    bly1 => { # {{{
      gid => 5005,
    }, # }}}
    sdeodhar => { # {{{
      gid => 5006,
    }, # }}}
    snaik1 => { # {{{
      gid => 5007,
    }, # }}}
    sbryan5 => { # {{{
      gid => 5008,
    }, # }}}
    sagrawa2 => { # {{{
      gid => 5009,
    }, # }}}
    rmcalave => { # {{{
      gid => 5010,
    }, # }}}
    lgiaedon => { # {{{
      gid => 5011,
    }, # }}}
  },
  user => {
    sneilso1 => { # {{{
      uid => 5001,
      name => 'Simon Neilson',
      gid => 5001,
      home => '/app/home/sneilso1',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '$6$nDTWp3fd$EbXlF6dKVpM.Zn2TT2gZ0sHPpX9sKklyu1EE5.EnJrszr74RwokrroQVkfyfSTVv3IHuyV.r8m107oqybNKVo1',
      force_password => 1,
    }, # }}}
    kbessaih => { # {{{
      uid => 5002,
      name => 'Khalef Bessaih',
      gid => 5002,
      home => '/app/home/kbessaih',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '',
      force_password => 1,
    }, # }}}
    cnithyan => { # {{{
      uid => 5003,
      name => 'Chandra Nithyanantham',
      gid => 5003,
      home => '/app/home/cnithyan',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '',
      force_password => 1,
    }, # }}}
    dvandort => { # {{{
      uid => 5004,
      name => 'Dianne Van Dort',
      gid => 5004,
      home => '/app/home/dvandort',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '',
      force_password => 1,
    }, # }}}
    bly1 => { # {{{
      uid => 5005,
      name => 'Ba Ly',
      gid => 5005,
      home => '/app/home/bly1',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '',
      force_password => 1,
    }, # }}}
    sdeodhar => { # {{{
      uid => 5006,
      name => 'Shalaka Deodhar',
      gid => 5006,
      home => '/app/home/sdeodhar',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '',
      force_password => 1,
    }, # }}}
    snaik1 => { # {{{
      uid => 5007,
      name => 'Supreeth Naik',
      gid => 5007,
      home => '/app/home/snaik1',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '',
      force_password => 1,
    }, # }}}
    sbryan5 => { # {{{
      uid => 5008,
      name => 'Steve Bryan',
      gid => 5008,
      home => '/app/home/sbryan5',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '',
      force_password => 1,
    }, # }}}
    sagrawa2 => { # {{{
      uid => 5009,
      name => 'Sumit Agrawal',
      gid => 5009,
      home => '/app/home/sagrawa2',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '$6$Uql3B6JZ$L9UZiiTnCNtA90TKIEX6tpLsXBPuuvHFynL1ZJnBO2cYhypPSg.s/cgFBR6elAoVZH6giVyQMJ7i3YSL2F6.A/',
      force_password => 1,
    }, # }}}
    rmcalave => { # {{{
      uid => 5010,
      name => 'Robert McAlavey',
      gid => 5010,
      home => '/app/home/rmcalave',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '',
      force_password => 1,
    }, # }}}
    lgiaedon => { # {{{
      uid => 5011,
      name => 'Luciano Giaedoni',
      gid => 5011,
      home => '/app/home/lgiaedon',
      shell => '/bin/bash',
      groups => ['operator'],
      password => '',
      force_password => 1,
    }, # }}}
  },
}; # }}}

class Postfix_Server => { # {{{
  packages => [qw( postfix mailutils )],
  file_install => {
    "/etc/postfix/main.cf" => {
      source => "rollout:/files/postfix/main.cf.server",
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "/etc/init.d/postfix restart",
    },
  },
}; # }}}
class Postfix_Client => { # {{{
  packages => [qw( mailutils )],
  file_install => {
    "/etc/postfix/main.cf" => {
      source => "rollout:/files/postfix/main.cf",
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "/etc/init.d/postfix restart",
    },
  },
}; # }}}

class Bind9_Server => { # {{{
  packages => [
    'bind9',
  ],
  file_install => {
    "/etc/bind/named.conf" => {
      mode => 0644,
      owner => 'root',
      group => 'root',
      text => 'include "/etc/bind/named.conf.local";',
      command => "/etc/init.d/bind9 restart",
    },
  },
  symlink => {
    "/etc/bind/rndc.key" => "/app/bind/rndc.key",
  },
  file_modify => [
    "/etc/bind/db.root" => [
      's/^[^#]*AAAA.*$/#$&/',
    ],
  ],
  file_append => [
    {
      file => "/etc/bind/named.conf.local",
      add => 'include "/app/bind/named.conf.options";',
      match => qr/named.conf.options/,
      create => 1,
      cmd => "/etc/init.d/bind9 restart",
    },
    {
      file => "/etc/bind/named.conf.local",
      add => 'include "/app/bind/aws.tmcr.target.internal.conf";',
      match => qr/aws.tmcr.target.internal.conf/,
      create => 1,
      cmd => "/etc/init.d/bind9 restart",
    },
  ],
}; # }}}
class Nagios3_Server => { # {{{
  service => {
    nagios3 => 1,
  },
  packages => [
    'nagios3',
    'nagios-plugins',
    'snmp',
    'libnet-snmp-perl',
    'nagios-images',
  ],
  user => {
    "www-data" => {
      groups => ['nagios'],
    },
  },
  symlink => {
    "/etc/apache2/conf.d/nagios3.conf" => "/app/nagios/apache2/nagios3.conf",
    "/etc/nagios3" => "/app/nagios/nagios3",
    "/etc/apache2/conf.d/nagios3.conf" => "/app/nagios/apache2/nagios3.conf",
    "/etc/nagios-plugins" => "/app/nagios/nagios-plugins",
    "/etc/nagios" => "/app/nagios/etc",
    #"/usr/share/nagios" => "/app/nagios/share/nagios",
    "/usr/share/nagios3" => "/app/nagios/share/nagios3",
    "/usr/share/nagios-plugins" => "/app/nagios/share/nagios-plugins",
  },
  dir_check => [
    [ '/app/nagios/var/nagios3/rw', 0755, 'nagios', 'nagios' ],
  ],
}; # }}}
class Rollout_Server => { # {{{
  inherits(
    Apache2_Server,
    Postfix_Server,
  ),
  packages => [
    'libapache2-mod-php5',
    'liberror-perl',
    'libwww-perl',
    'apt-mirror',
    'apg',
  ],
  symlink => {
    "/etc/apache2/mods-enabled/proxy.load" => "/etc/apache2/mods-available/proxy.load",
    "/etc/apache2/mods-enabled/proxy_http.load" => "/etc/apache2/mods-available/proxy_http.load",
    "/etc/apache2/mods-enabled/rewrite.load" => "/etc/apache2/mods-available/rewrite.load",
  },
}; # }}}
class Kickstart_Server => { # {{{
  inherits(
    Apache2_Server
    ),
  packages => [qw( bind9 atftp )],
}; # }}}
class Apt_Mirror_Server => { # {{{
  packages => [qw( apt-mirror )],
  file_install => {
    "/etc/cron.d/apt-mirror" => {
      source => "rollout:/files/mgmt/apt-mirror",
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "/etc/init.d/cron restart",
    },
  },
  user => {
    "apt-mirror" => {
      home => '/app/apt-mirror',
      homedir_mode => 0755,
    },
  },
}; # }}}
class Splunk_Server => { # {{{
}; # }}}
class NFS_Client => { # {{{
  packages => [
    'nfs-common',
  ],
}; # }}}
class NFS_Server => { # {{{
  packages => [
    'nfs-kernel-server',
  ],
  file_append => [
    {
      file => "/etc/default/nfs-common",
      match => qr/^NEED_GSSD/,
      add => 'NEED_GSSD="no"',
      cmd => "service statd restart",
    },
    {
      file => "/etc/default/nfs-common",
      match => qr/^NEED_STATD/,
      add => 'NEED_STATD="yes"',
      cmd => "service statd restart",
    },
    {
      file => "/etc/default/nfs-common",
      match => qr/^STATDOPTS/,
      add => 'STATDOPTS="--port 65001 --outgoing-port 65002"',
      cmd => "service statd restart",
    },
    {
      file => "/etc/default/nfs-kernel-server",
      match => qr/^RPCNFSDOPTS/,
      add => 'RPCNFSDOPTS="--syslog"',
      cmd => "/etc/init.d/nfs-kernel-server restart",
    },
    {
      file => "/etc/default/nfs-kernel-server",
      match => qr/^RPCMOUNTDOPTS/,
      add => 'RPCMOUNTDOPTS="--no-nfs-version 4 --manage-gids --port 65000 --nfs-version 3 --num-threads=4"',
      cmd => "/etc/init.d/nfs-kernel-server restart",
    },
    {
      file => "/etc/default/nfs-kernel-server",
      match => qr/^RPCNFSDCOUNT/,
      add => 'RPCNFSDCOUNT="8 --no-nfs-version 4"',
      cmd => "/etc/init.d/nfs-kernel-server restart",
    },
  ],
}; # }}}

class Primus_Mgmt => { # {{{
  inherits(
    Primus,
  ),
  apt => {
    repos => [
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise main',
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates main',
      'deb http://10.227.192.34/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security main',
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise universe',
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates universe',
      'deb http://10.227.192.34/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security universe',
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise multiverse',
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates multiverse',
      'deb http://10.227.192.34/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security restricted',
    ],
    always_check => 1,
    auto_upgrade => 0,
  },
}; # }}}
class Primus_Non_Mgmt => { # {{{
  inherits(
    Primus,
    Splunk_Client,
  ),
  user => {
    target => {
      name => "Target User",
      home => '/home/target',
      homedir_mode => 0755,
      groups => ['admin', 'adm'],
      password => '$6$.jJxsiBV$iWKQjdOi36eMlExohYIWtlIdzgyu6tYT.P3BqbfErGNVchs5AWe/8a9vlXNsbOUdY/qa/txT2jw1FBkjd9Y91.',
      ssh_keys => ["target\@lpahy01vm", "cdonova1\@lmabd01vm"]
    },
    primus => {
      name => "Primus User",
      home => '/home/primus',
      groups => ['admin'],
      password => '$6$uZcdrodX$MKsYcc3Ug9K1hSlbREpTOxnZrD2kTHej55lpEFb76ASe5w6N1CRBeV32XjStyqPFQmCn2dZOPyEHv311oBYrc1',
    },
  },
}; # }}}

class AWS_Mgmt => { # {{{
  inherits(
    AWS,
    Postfix_Client,
    NFS_Client,
  ),
}; # }}}
class AWS_Non_Mgmt => { # {{{
  inherits(
    AWS,
    AWS_Users,
    Postfix_Client,
  ),
}; # }}}

class Primus_Production => { # {{{
  inherits(
    Primus_Non_Mgmt,
  ),
  apt => {
    repos => [
      'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise main universe',
      'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates main universe',
      'deb http://10.227.192.34/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security main universe',
      #'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise universe',
      #'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates universe',
      #'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise-security universe',
      #'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise multiverse',
      #'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates multiverse',
      #'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise-security multiverse',
      #'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise restricted',
      #'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates restricted',
      #'deb http://10.227.192.34/ubuntu/prod/mirror/archive.ubuntu.com/ubuntu/ precise-security restricted',
    ],
    always_check => 1,
    auto_upgrade => 0,
  },
}; # }}}
class Primus_STG => { # {{{
  inherits(
    Primus_Non_Mgmt,
  ),
  apt => {
    repos => [
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise main universe',
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates main universe',
      'deb http://10.227.192.34/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security main universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security restricted',
    ],
    always_check => 1,
    auto_upgrade => 0,
  },
}; # }}}
class Primus_UAT => { # {{{
  inherits(
    Primus_Non_Mgmt,
  ),
  apt => {
    repos => [
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise main universe',
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates main universe',
      'deb http://10.227.192.34/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security main universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security restricted',
    ],
    always_check => 1,
    auto_upgrade => 0,
  },
}; # }}}
class Primus_QAT => { # {{{
  inherits(
    Primus_Non_Mgmt,
  ),
  apt => {
    repos => [
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise main universe',
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates main universe',
      'deb http://10.227.192.34/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security main universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security restricted',
    ],
    always_check => 1,
    auto_upgrade => 0,
  },
}; # }}}
class Primus_DEV => { # {{{
  inherits(
    Primus_Non_Mgmt,
  ),
  apt => {
    repos => [
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise main universe',
      'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates main universe',
      'deb http://10.227.192.34/ubuntu/security/mirror/archive.ubuntu.com/ubuntu/ precise-security main universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security universe',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security multiverse',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-updates restricted',
      #'deb http://10.227.192.34/ubuntu/non-prod/mirror/archive.ubuntu.com/ubuntu/ precise-security restricted',
    ],
    always_check => 1,
    auto_upgrade => 0,
  },
}; # }}}

class AWS_DEV => { # {{{
  inherits(
    AWS_Non_Mgmt,
    NFS_Client,
  ),
}; # }}}
class AWS_QAT => { # {{{
  inherits(
    AWS_Non_Mgmt,
  ),
  file_extract => {
    "rollout:/files/aws/jdk/jdk-6u38-linux-x64.tar.gz" => {
      dest => "/usr/lib/jvm",
      check => "/usr/lib/jvm/jdk1.6.0_38",
      cmd => 'update-alternatives --set java /usr/lib/jvm/jdk1.6.0_38/bin/java ; update-alternatives --set javac /usr/lib/jvm/jdk1.6.0_38/bin/javac ; update-alternatives --set javaws /usr/lib/jvm/jdk1.6.0_38/bin/javaws',
    },
    "rollout:/files/aws/jdk/jdk-7u11-linux-x64.tar.gz" => {
      dest => "/usr/lib/jvm",
      check => "/usr/lib/jvm/jdk1.7.0_11",
    },
  },
}; # }}}
class AWS_UAT => { # {{{
  inherits(
    AWS_Non_Mgmt,
  ),
}; # }}}
class AWS_STG => { # {{{
  inherits(
    AWS_Non_Mgmt,
  ),
}; # }}}

class Apache2_Server => { # {{{
  service => {
    apache2 => 1,
  },
  packages => [qw( apache2 )],
  file_append => [
    {
      file => "/etc/default/apache2",
      add => 'HTCACHECLEAN_OPTIONS="-t -n"',
      match => qr/^HTCACHECLEAN_OPTIONS.*$/,
      create => 1,
      cmd => "/etc/init.d/apache2 stop-htcacheclean && /etc/init.d/apache2 start-htcacheclean",
    },
  ],
}; # }}}
class Hybris_Server => { # {{{
  rollout => {
    reorder_steps => [ # Change the order of steps
      "240-dir_check" => 252,
    ],
  },
  symlink => {
    "/app/shared" => "/misc/app_shared",
  },
  user => {
    hybris => {
      name => "Hybris User",
      home => '/home/hybris',
      shell => '/bin/bash',
      uid => 1003,
      password => '$6$SuJ6zoVD$nTpMM2r.QNTJWvnfhRkcVf1FxleD3n0ZL053WvA1IH/m17Oituze7mm7gZrUZumeSEG8CBqHqHahNrLi8Mp4f1',
      ssh_keys => ["target\@lpahy01vm", "cdonova1\@lmabd01vm"]
    },
    solr => {
      name => "SOLR User",
      home => '/home/solr',
      shell => '/bin/bash',
      uid => 1002,
    },
  },
  dir_check => [
    [ '/misc', 0755, 'root', 'root' ],
    [ '/misc/app_shared', 0755, 'hybris', 'hybris' ],
    [ '/app', 0755, 'root', 'root' ],
    [ '/app/STEP_HYBRIS', 0755, 'hybris', 'hybris' ],
  ],
  file_extract => {
    "rollout:/files/jvm/jvm-java-6-sun.tar.gz" => {
      dest => "/usr/lib",
      check => "/usr/lib/jvm/java-6-sun-1.6.0.22",
      cmd => 'update-alternatives --install "/usr/bin/java" "java" /usr/lib/jvm/java-6-sun/bin/java 1 ; update-alternatives --install "/usr/bin/javac" "javac" /usr/lib/jvm/java-6-sun/bin/javac 1 ; update-alternatives --install "/usr/bin/javaws" "javaws" /usr/lib/jvm/java-6-sun/bin/javaws 1 ; ',
    },
    "rollout:/files/jvm/java-6-sun_etc.tar.gz" => {
      dest => "/etc",
      check => "/etc/java-6-sun",
    },
  },
  file_append => [
    {
      file => "/etc/fstab",
      add => "/dev/sdb1 /app ext4 defaults 0 2",
      match => qr%/dev/sdb1 %,
      #cmd => "mount -o remount /app",
    },
  ],
}; # }}}
class Backoffice_Server => { # {{{
  rollout => {
    reorder_steps => [ # Change the order of steps
      "240-dir_check" => 252,
    ],
  },
  group => {
    storeloc => {
      gid => 1009,
    },
  },
  user => {
    hybris => {
      name => "Hybris User",
      home => '/home/hybris',
      homedir_mode => 0755,
      uid => 1003,
      password => '$6$SuJ6zoVD$nTpMM2r.QNTJWvnfhRkcVf1FxleD3n0ZL053WvA1IH/m17Oituze7mm7gZrUZumeSEG8CBqHqHahNrLi8Mp4f1',
      ssh_keys => [
        "target\@lpahy01vm",
        "cdonova1\@lmabd01vm",
      ]
    },
    solr => {
      name => "SOLR User",
      home => '/home/solr',
      uid => 1002,
    },
    storeloc => {
      name => "Storeloc User",
      home => '/home/hybris/productImport/store_locator',
      shell => '/bin/bash',
      homedir_mode => 02775,
      uid => 1009,
      gid => 1003,
      password => '$6$OUoVFPuq$FulhlmUPgVaYnVdj0tu3tva/gVBql8N8d0Wl/ZHj7LiClIVLpQRZWKL6j594X4ae0TidwkUhPXvPdpk.oUQfL/',
    },
  },
  dir_check => [
    [ '/misc/app_shared', 0755, 'hybris', 'hybris' ],
    [ '/app/STEP_HYBRIS', 0755, 'hybris', 'hybris' ],
  ],
  file_extract => {
    "rollout:/files/jvm/jvm-java-6-sun.tar.gz" => {
      dest => "/usr/lib",
      check => "/usr/lib/jvm/java-6-sun-1.6.0.22",
      cmd => 'update-alternatives --install "/usr/bin/java" "java" /usr/lib/jvm/java-6-sun/bin/java 1 ; update-alternatives --install "/usr/bin/javac" "javac" /usr/lib/jvm/java-6-sun/bin/javac 1 ; update-alternatives --install "/usr/bin/javaws" "javaws" /usr/lib/jvm/java-6-sun/bin/javaws 1 ; ',
    },
    "rollout:/files/jvm/java-6-sun_etc.tar.gz" => {
      dest => "/etc",
      check => "/etc/java-6-sun",
    },
  },
}; # }}}
class Nexus_Server => { # {{{
  group => {
    nexus => {
      gid => 1015,
    },
  },
  user => {
    nexus => {
      uid => 1015,
      gid => 1015,
      home => '/app/nexus',
      homedir_mode => 0755,
      shell => '/bin/false',
    },
  },
}; # }}}
class Splunk_Client => { # {{{
  file_extract => {
    "rollout:/files/splunk/splunk.tar.gz" => {
      dest => "/",
      check => "/opt/splunkforwarder/bin/splunkd",
    },
  },
  file_append => [
    {
      file => "/opt/splunkforwarder/etc/system/local/inputs.conf",
      add => "host = $hostname",
      match => qr/^host/,
      cmd => "echo '======== START / RESTART SPLUNK ============='",
    },
    {
      file => "/opt/splunkforwarder/etc/system/local/server.conf",
      add => "serverName = $hostname",
      match => qr/^serverName/,
      cmd => "echo '======== START / RESTART SPLUNK ============='",
    },
  ],
}; # }}}
class Jenkins_Server => { # {{{
  apt => {
    repos => [
      'deb http://pkg.jenkins-ci.org/debian binary/',
    ],
    always_check => 1,
    auto_upgrade => 0,
  },
  packages => [
    'jenkins',
    'ant',
    'python',
    'git',
    'maven2',
  ],
  file_extract => {
    "rollout:/files/aws/jdk/jdk-6u38-linux-x64.tar.gz" => {
      dest => "/usr/lib/jvm",
      check => "/usr/lib/jvm/jdk1.6.0_38",
      cmd => 'update-alternatives --set java /usr/lib/jvm/jdk1.6.0_38/bin/java ; update-alternatives --set javac /usr/lib/jvm/jdk1.6.0_38/bin/javac ; update-alternatives --set javaws /usr/lib/jvm/jdk1.6.0_38/bin/javaws',
    },
    "rollout:/files/aws/jdk/jdk-7u11-linux-x64.tar.gz" => {
      dest => "/usr/lib/jvm",
      check => "/usr/lib/jvm/jdk1.7.0_11",
    },
  },
  file_modify => [
    "/etc/default/jenkins" => [
      's/^HTTP_PORT.*/HTTP_PORT=8080/',
    ],
    "/etc/default/jenkins" => [
      's%^JENKINS_HOME.*%JENKINS_HOME=/app/jenkins%',
    ],	
    "/etc/default/jenkins" => [
      's%^#JAVA_ARGS="-Xmx.*%JAVA_ARGS="-Xmx256m -XX:PermSize=128m -XX:MaxPermSize=128m"%',
    ],


  ],
  user => {
    jenkins => { 
      uid => 107,
      name => 'Jenkins Release Build Service',
      gid => 65534,
      home => '/app/jenkins',
      homedir_mode => 0755,
      shell => '/bin/bash',
      groups => ['operator'],
      password => '$6$WDipgQRs$tfGY/jxO0UI7yFguJDQxsegw0qM0WBVkoxwaGPTwl.rlnObIAp4jwayPPvK2eaCjbCwvuiJsJ1ZBizRa5zc7D1',
      force_password => 1,
    },
  },
}; # }}}
class Artifactory_Server => { # {{{
  file_extract => {
    "rollout:/files/aws/artifactory/artifactory-2.6.6.tar.gz" => {
      dest => "/app",
      check => "/app/artifactory-2.6.6",
      #cmd  => "/app/artifactory-2.6.6/bin/install.sh artifactory; /etc/init.d/artifactory start",
    },
  },
#  file_append => [
#    {
#      file => "/app/artifactory-2.6.6/bin/artifactory.default",
#      add => "\n",
#      match => qr%"$%,
#      cmd => "/app/artifactory-2.6.6/bin/install.sh artifactory; /etc/init.d/artifactory start",
#    },
#  ],
  user => {
    artifactory => {
      uid => 108,
      name => 'Artifactory Service',
      gid => 65534,
      home => '/app/home/artifactory',
      shell => '/bin/false',
    },
  },
}; # }}}
class Sonar_Server => { # {{{
  file_extract => {
    "rollout:/files/aws/sonar/sonar-3.4.1.tar.gz" => {
      dest => "/app",
      check => "/app/sonar-3.4.1",
      cmd  => "/app/sonar-3.4.1/bin/linux-x86-64/sonar.sh start",
    },
  },
  user => {
    sonar => {
      uid => 109,
      name => 'Artifactory Service',
      gid => 65534,
      home => '/app/home/sonar',
      shell => '/bin/false',
    },
  },
}; # }}}

class AWS_Backoffice_Server => { # {{{
  inherits(
    NFS_Client,
  ),
  group => {
    hybris => {
      gid => 1003,
    },
  },
  user => {
    hybris => {
      name => "Hybris User",
      home => '/app/home/hybris',
      shell => '/bin/bash',
      uid => 1003,
      gid => 1003,  
      password => '*LK*',
      force_password => 1,
    },
  },
  dir_check => [
      [ '/app/hybris', 0755, 'hybris', 'hybris' ],
  ],
  file_extract => {
    "rollout:/files/aws/jdk/jdk-6u38-linux-x64.tar.gz" => {
      dest => "/usr/lib/jvm",
      check => "/usr/lib/jvm/jdk1.6.0_38",
      cmd => 'update-alternatives --set java /usr/lib/jvm/jdk1.6.0_38/bin/java ; update-alternatives --set javac /usr/lib/jvm/jdk1.6.0_38/bin/javac ; update-alternatives --set javaws /usr/lib/jvm/jdk1.6.0_38/bin/javaws',
    },
    "rollout:/files/aws/jdk/jdk-7u11-linux-x64.tar.gz" => {
      dest => "/usr/lib/jvm",
      check => "/usr/lib/jvm/jdk1.7.0_11",
    },
  },
}; # }}}
class AWS_Hybris_Server => { # {{{
  inherits(
    NFS_Client,
  ),
  group => {
    hybris => {
      gid => 1003,
    },
  },
  user => {
    hybris => {
      name => "Hybris User",
      home => '/app/home/hybris',
      shell => '/bin/bash',
      uid => 1003,
      gid => 1003,  
      password => '*LK*',
      force_password => 1,
    },
  },
  dir_check => [
      [ '/app/hybris', 0755, 'hybris', 'hybris' ],
  ],
  file_extract => {
    "rollout:/files/aws/jdk/jdk-6u38-linux-x64.tar.gz" => {
      dest => "/usr/lib/jvm",
      check => "/usr/lib/jvm/jdk1.6.0_38",
      cmd => 'update-alternatives --set java /usr/lib/jvm/jdk1.6.0_38/bin/java ; update-alternatives --set javac /usr/lib/jvm/jdk1.6.0_38/bin/javac ; update-alternatives --set javaws /usr/lib/jvm/jdk1.6.0_38/bin/javaws',
    },
    "rollout:/files/aws/jdk/jdk-7u11-linux-x64.tar.gz" => {
      dest => "/usr/lib/jvm",
      check => "/usr/lib/jvm/jdk1.7.0_11",
    },
  },  
  
}; # }}}
class AWS_ESB_Server => { # {{{
  inherits(
    NFS_Client,
  ),
}; # }}}
class AWS_Silk_Server => { # {{{
  inherits(
    NFS_Client,
  ),
}; # }}}

class Prod_Apache2 => { # {{{
  inherits(
    Primus_Production,
    Apache2_Server,
  ),
  dir_install => {
    '/etc/apache2' => {
      source => 'rollout:/files/production/apache2',
      dir_mode => 0755,
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "rm /etc/apache2/sites-enabled/000-default ; rm /etc/apache2/conf.d/other-vhosts-access-log ; /etc/init.d/apache2 restart",
    },
    '/var/www' => {
      source => 'rollout:/files/production/www',
      dir_mode => 0755,
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "/etc/init.d/apache2 restart",
    },
  },
  file_append => [
    {
      file => "/etc/fstab",
      add => "lpame01vm:/app/shared/sys_master /var/www/medias/sys_master nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lpame01vm:/app/shared/sys_master %,
      #cmd => "mount -o remount /var/www/medias/sys_master",
    },
    {
      file => "/etc/fstab",
      add => "lpame01vm:/app/shared/sys_master /var/www/medias/sys_master nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lpame01vm:/app/shared/sys_master %,
      #cmd => "mount -o remount /var/www/medias/sys_master",
    },
  ],
  user => {
    target => {
      ssh_keys => ["target\@lpawe01vm", "target\@lpawe02vm", "target\@lpawe03vm", "target\@lpawe04vm", "target\@lpahy01vm"]
    },
  },
}; # }}}
class Primus_STG_Apache2 => { # {{{
  inherits(
    Primus_STG,
    Apache2_Server,
  ),
  file_extract => {
    "rollout:/files/staging/dynatrace/dynatrace-4.1.0.tar.gz" => {
      dest => "/app",
      check => "/app/dynatrace-4.1.0",
    },
  },
  dir_install => {
    '/etc/apache2' => {
      source => 'rollout:/files/staging/apache2',
      dir_mode => 0755,
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "rm /etc/apache2/sites-enabled/000-default ; rm /etc/apache2/conf.d/other-vhosts-access-log ; /etc/init.d/apache2 restart",
    },
    '/var/www' => {
      source => 'rollout:/files/staging/www',
      dir_mode => 0755,
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "/etc/init.d/apache2 restart",
    },
  },
  symlink => {
    "/etc/apache2/sites-enabled/vhost.conf" => "/etc/apache2/sites-available/vhost.conf.filtered",
  },
  file_append => [
    {
      file => "/etc/fstab",
      add => "lsame01vm:/app/shared/sys_master /var/www/medias/sys_master nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lsame01vm:/app/shared/sys_master %,
      #cmd => "mount -o remount /var/www/medias/sys_master",
    },
  ],
}; # }}}
class Primus_UAT_Apache2 => { # {{{
  inherits(
    Primus_UAT,
    Apache2_Server,
  ),
  dir_install => {
    '/etc/apache2' => {
      source => 'rollout:/files/uat/apache2',
      dir_mode => 0755,
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "rm /etc/apache2/sites-enabled/000-default ; rm /etc/apache2/conf.d/other-vhosts-access-log ; /etc/init.d/apache2 restart",
    },
    '/var/www' => {
      source => 'rollout:/files/uat/www',
      dir_mode => 0755,
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "/etc/init.d/apache2 restart",
    },
  },
  file_append => [
    {
      file => "/etc/fstab",
      add => "luabo01vm:/app/shared/sys_master /var/www/medias/sys_master nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^luabo01vm:/app/shared/sys_master %,
      #cmd => "mount -o remount /var/www/medias/sys_master",
    },
  ],
}; # }}}
class Primus_QAT_Apache2 => { # {{{
  inherits(
    Primus_QAT,
    Apache2_Server,
  ),
  dir_install => {
    '/etc/apache2' => {
      source => 'rollout:/files/qa/apache2',
      dir_mode => 0755,
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "rm /etc/apache2/sites-enabled/000-default ; rm /etc/apache2/conf.d/other-vhosts-access-log ; /etc/init.d/apache2 restart",
    },
    '/var/www' => {
      source => 'rollout:/files/qa/www',
      dir_mode => 0755,
      mode => 0644,
      owner => 'root',
      group => 'root',
      command => "/etc/init.d/apache2 restart",
    },
  },
  file_append => [
    {
      file => "/etc/fstab",
      add => "10.227.194.171:/app/shared/sys_master /var/www/medias/sys_master nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^10.227.194.171:/app/shared/sys_master %,
      #cmd => "mount -o remount /var/www/medias/sys_master",
    },
  ],
}; # }}}

class AWS_QAT_Apache2 => { # {{{
  inherits(
    AWS_QAT,
    Apache2_Server,
  ),
}; # }}}
class AWS_QAT_Hybris => { # {{{
  inherits(
    AWS_QAT,
    AWS_Hybris_Server,
  ),
}; # }}}
class AWS_QAT_Bo => { # {{{
  inherits(
    AWS_QAT,
    AWS_Backoffice_Sever
  ),
}; # }}}
class AWS_QAT_ESB => { # {{{
  inherits(
    AWS_QAT,
    AWS_ESB_Server,
  ),
}; # }}}

class AWS_UAT_Apache2 => { # {{{
  inherits(
    AWS_UAT,
    Apache2_Server,
  ),
}; # }}}
class AWS_UAT_Hybris => { # {{{
  inherits(
    AWS_UAT,
    AWS_Hybris_Server,
  ),
}; # }}}
class AWS_UAT_Bo => { # {{{
  inherits(
    AWS_UAT,
    AWS_Backoffice_Sever
  ),
}; # }}}

class AWS_STG_Apache2 => { # {{{
  inherits(
    AWS_STG,
    Apache2_Server,
  ),
}; # }}}
class AWS_STG_Hybris => { # {{{
  inherits(
    AWS_STG,
    AWS_Hybris_Server,
  ),
}; # }}}
class AWS_STG_Bo => { # {{{
  inherits(
    AWS_STG,
    AWS_Backoffice_Sever
  ),
}; # }}}
class AWS_STG_Silk => { # {{{
  inherits(
    AWS_STG,
    AWS_Silk_Server,
  ),
}; # }}}

class Prod_Solr => { # {{{
  inherits(
    Primus_Production,
  ),
}; # }}}
class Prod_Hybris => { # {{{
  inherits(
    Hybris_Server,
    Primus_Production,
  ),
  file_append => [
    {
      file => "/etc/fstab",
      add => "lpame01vm:/app/shared /misc/app_shared nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lpame01vm:/app/shared %,
      #cmd => "mount -o remount /misc/app_shared",
    },
  ],
  file_extract => {
    "rollout:/files/production/hybris/app.tar.gz" => {
      dest => "/",
      check => "/app/hybris",
      cmd => 'find /app/SOLR -name "*.lock" -exec sudo rm {} \;',
    },
  },
}; # }}}
class Prod_Bo => { # {{{
  inherits(
    Backoffice_Server,
    Primus_Production,
  ),
  symlink => {
    "/app/shared" => "/misc/app_shared",
  },
  file_append => [
    {
      file => "/etc/fstab",
      add => "lpame01vm:/app/shared /misc/app_shared nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lpame01vm:/app/shared %,
      #cmd => "mount -o remount /misc/app_shared",
    },
  ],
  file_extract => {
    "rollout:/files/production/hybris/app.tar.gz" => {
      dest => "/",
      check => "/app/hybris",
      cmd => 'find /app/SOLR -name "*.lock" -exec sudo rm {} \;',
    },
  },
}; # }}}

class Primus_STG_Hybris => { # {{{
  inherits(
    Primus_STG,
    Hybris_Server,
  ),
  file_append => [
    {
      file => "/etc/fstab",
      add => "lsame01vm:/app/shared /misc/app_shared nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lsame01vm:/app/shared %,
      #cmd => "mount -o remount /misc/app_shared",
    },
  ],
  file_extract => {
    "rollout:/files/staging/hybris/app.tar.gz" => {
      dest => "/",
      check => "/app/hybris",
      cmd => 'find /app/SOLR -name "*.lock" -exec sudo rm {} \;',
    },
    "rollout:/files/staging/dynatrace/dynatrace-4.1.0.tar.gz" => {
      dest => "/app",
      check => "/app/dynatrace-4.1.0",
    },
    "rollout:/files/staging/dynatrace/opt_dynatrace.tar.gz" => {
      dest => "/opt",
      check => "/opt/dynatrace",
    },
  },
}; # }}}
class Primus_STG_Bo => { # {{{
  inherits(
    Primus_STG,
    Backoffice_Server,
  ),
  symlink => {
    "/app/shared" => "/misc/app_shared",
  },
  file_append => [
    {
      file => "/etc/fstab",
      add => "lsame01vm:/app/shared /misc/app_shared nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lsame01vm:/app/shared %,
      #cmd => "mount -o remount /misc/app_shared",
    },
    {
      file => "/etc/fstab",
      add => "lsame01vm:/app/STEP /app/STEP_HYBRIS nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lsame01vm:/app/STEP %,
      #cmd => "mount -o remount /app/STEP_HYBRIS",
    },
  ],
  file_extract => {
    "rollout:/files/staging/bo/app.tar.gz" => {
      dest => "/",
      check => "/app/hybris",
      cmd => 'find /app/SOLR -name "*.lock" -exec sudo rm {} \;',
    },
  },
}; # }}}

class Primus_UAT_Hybris => { # {{{
  inherits(
    Primus_UAT,
    Hybris_Server,
  ),
  file_append => [
    {
      file => "/etc/fstab",
      add => "luabo01vm:/app/shared /misc/app_shared nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^luabo01vm:/app/shared %,
      #cmd => "mount -o remount /misc/app_shared",
    },
  ],
  file_extract => {
    "rollout:/files/uat/hybris/app.tar.gz" => {
      dest => "/",
      check => "/app/hybris",
      cmd => 'find /app/SOLR -name "*.lock" -exec sudo rm {} \;',
    },
  },
}; # }}}
class Primus_UAT_Bo => { # {{{
  inherits(
    Primus_UAT,
    Backoffice_Server,
  ),
  file_append => [
    {
      file => "/etc/fstab",
      add => "luabo01vm:/app/shared /misc/app_shared nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^luabo01vm:/app/shared %,
      #cmd => "mount -o remount /misc/app_shared",
    },
    {
      file => "/etc/fstab",
      add => "lsame01vm:/app/STEP /app/STEP_HYBRIS nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lsame01vm:/app/STEP %,
      #cmd => "mount -o remount /app/STEP_HYBRIS",
    },
  ],
  file_extract => {
    "rollout:/files/uat/bo/app.tar.gz" => {
      dest => "/",
      check => "/app/hybris",
      cmd => 'find /app/SOLR -name "*.lock" -exec sudo rm {} \;',
    },
  },
}; # }}}

class Primus_QAT_Hybris => { # {{{
  inherits(
    Primus_QAT,
    Hybris_Server,
  ),
  file_append => [
    {
      file => "/etc/fstab",
      add => "lqabo01vm:/app/shared /misc/app_shared nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lqabo01vm:/app/shared %,
      #cmd => "mount -o remount /misc/app_shared",
    },
  ],
  file_extract => {
    "rollout:/files/qa/hybris/app.tar.gz" => {
      dest => "/",
      check => "/app/hybris",
      cmd => 'find /app/SOLR -name "*.lock" -exec sudo rm {} \;',
    },
  },
}; # }}}
class Primus_QAT_Bo => { # {{{
  inherits(
    Primus_QAT,
    Bo_Server,
  ),
  symlink => {
    "/app/shared" => "/misc/app_shared",
  },
  file_append => [
    {
      file => "/etc/fstab",
      add => "lqabo01vm:/app/shared /misc/app_shared nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lqabo01vm:/app/shared %,
      #cmd => "mount -o remount /misc/app_shared",
    },
    {
      file => "/etc/fstab",
      add => "lsame01vm:/app/STEP /app/STEP_HYBRIS nfs _netdev,rw,hard,intr,vers=3,bg 0 0",
      match => qr%^lsame01vm:/app/STEP %,
      #cmd => "mount -o remount /app/STEP_HYBRIS",
    },
  ],
  file_extract => {
    "rollout:/files/qa/bo/app.tar.gz" => {
      dest => "/",
      check => "/app/hybris",
      cmd => 'find /app/SOLR -name "*.lock" -exec sudo rm {} \;',
    },
  },
}; # }}}
